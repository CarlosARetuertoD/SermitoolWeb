<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Administrar Puntos de Interés - Sermitool</title>
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding-top: 20px; }
    .img-container {
      position: relative;
      border: 1px solid #ddd;
      margin-bottom: 20px;
      overflow: hidden;
    }
    .img-container img {
      max-width: 100%;
      display: block;
    }
    .hotspot {
      position: absolute;
      width: 20px;
      height: 20px;
      background-color: rgba(0, 123, 255, 0.7);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      cursor: move;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      font-weight: bold;
    }
    .card {
      margin-bottom: 15px;
    }
    .coordinates {
      font-size: 12px;
      color: #666;
    }
    pre {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      max-height: 400px;
      overflow: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-4">Administrar Puntos de Interés</h1>
    
    <div class="row">
      <div class="col-md-8">
        <div class="card">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Imagen Actual</h5>
              <div class="btn-group">
                <button class="btn btn-sm btn-outline-primary" id="btn-trompa">Trompa</button>
                <button class="btn btn-sm btn-outline-primary" id="btn-cilindro">Cilindro</button>
                <button class="btn btn-sm btn-outline-primary" id="btn-cabezal">Cabezal</button>
                <button class="btn btn-sm btn-outline-primary" id="btn-maneral">Maneral</button>
                <button class="btn btn-sm btn-outline-primary" id="btn-barra">Barra</button>
                <button class="btn btn-sm btn-outline-primary" id="btn-lubricadora">Lubricadora</button>
              </div>
            </div>
          </div>
          <div class="card-body p-0">
            <div class="img-container">
              <img id="current-image" src="assets/img/products/jackleg-s250/partes/trompa.webp" alt="Parte">
              <!-- Los hotspots se generarán aquí -->
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Código JSON Generado</h5>
          </div>
          <div class="card-body">
            <pre id="json-output"></pre>
            <button id="copy-json" class="btn btn-primary">Copiar JSON</button>
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Repuestos</h5>
          </div>
          <div class="card-body">
            <div id="repuestos-container">
              <div class="alert alert-info">
                Cargando repuestos...
              </div>
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Agregar Punto</h5>
          </div>
          <div class="card-body">
            <form id="add-hotspot-form">
              <div class="mb-3">
                <label for="repuesto-id" class="form-label">Repuesto</label>
                <select id="repuesto-id" class="form-select">
                  <!-- Opciones se cargarán dinámicamente -->
                </select>
              </div>
              <button type="submit" class="btn btn-success">Agregar Punto</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Elementos del DOM
      const currentImage = document.getElementById('current-image');
      const imgContainer = document.querySelector('.img-container');
      const jsonOutput = document.getElementById('json-output');
      const repuestosContainer = document.getElementById('repuestos-container');
      const repuestoSelect = document.getElementById('repuesto-id');
      const addHotspotForm = document.getElementById('add-hotspot-form');
      const copyJsonBtn = document.getElementById('copy-json');
      
      // Botones de categoría
      const btnTrompa = document.getElementById('btn-trompa');
      const btnCilindro = document.getElementById('btn-cilindro');
      const btnCabezal = document.getElementById('btn-cabezal');
      const btnManeral = document.getElementById('btn-maneral');
      const btnBarra = document.getElementById('btn-barra');
      const btnLubricadora = document.getElementById('btn-lubricadora');
      
      let currentCategory = 'trompa';
      let allRepuestos = [];
      
      // Almacenamiento de hotspots por categoría
      const hotspotsPorCategoria = {
        'trompa': [],
        'cilindro': [],
        'cabezal': [],
        'maneral': [],
        'barra': [],
        'lubricadora': []
      };
      
      // Cargar los repuestos desde el JSON
      fetch('/assets/json/partes-jackleg-s250.json')
        .then(res => res.json())
        .then(data => {
          allRepuestos = data;
          
          // Rellenar el select con los repuestos filtrados por categoría
          updateRepuestosSelect();
          
          // Mostrar la lista de repuestos
          renderRepuestosList();
        });
      
      // Cambiar imagen y hotspots al hacer clic en los botones de categoría
      btnTrompa.addEventListener('click', () => changeCategory('trompa'));
      btnCilindro.addEventListener('click', () => changeCategory('cilindro'));
      btnCabezal.addEventListener('click', () => changeCategory('cabezal'));
      btnManeral.addEventListener('click', () => changeCategory('maneral'));
      btnBarra.addEventListener('click', () => changeCategory('barra'));
      btnLubricadora.addEventListener('click', () => changeCategory('lubricadora'));
      
      // Establecer la categoría activa
      function changeCategory(category) {
        currentCategory = category;
        currentImage.src = `assets/img/products/jackleg-s250/partes/${category}.webp`;
        
        // Actualizar UI
        [btnTrompa, btnCilindro, btnCabezal, btnManeral, btnBarra, btnLubricadora].forEach(btn => {
          btn.classList.remove('btn-primary');
          btn.classList.add('btn-outline-primary');
        });
        
        document.getElementById(`btn-${category}`).classList.remove('btn-outline-primary');
        document.getElementById(`btn-${category}`).classList.add('btn-primary');
        
        // Actualizar select de repuestos
        updateRepuestosSelect();
        
        // Renderizar hotspots actuales
        renderHotspots();
        
        // Actualizar JSON
        updateJsonOutput();
      }
      
      // Filtrar repuestos por categoría actual
      function updateRepuestosSelect() {
        const filteredRepuestos = allRepuestos.filter(r => 
          r.categoria && r.categoria.toLowerCase() === currentCategory
        );
        
        repuestoSelect.innerHTML = '';
        filteredRepuestos.forEach(r => {
          const option = document.createElement('option');
          option.value = r.id;
          option.textContent = `${r.id.toUpperCase()} - ${r.nombre} (#${r.numero_repuesto})`;
          repuestoSelect.appendChild(option);
        });
      }
      
      // Mostrar lista de repuestos de la categoría actual
      function renderRepuestosList() {
        repuestosContainer.innerHTML = '';
        
        const filteredRepuestos = allRepuestos.filter(r => 
          r.categoria && r.categoria.toLowerCase() === currentCategory
        );
        
        if (filteredRepuestos.length === 0) {
          repuestosContainer.innerHTML = '<div class="alert alert-warning">No hay repuestos en esta categoría</div>';
          return;
        }
        
        filteredRepuestos.forEach(r => {
          const div = document.createElement('div');
          div.className = 'mb-2';
          div.innerHTML = `
            <div class="d-flex align-items-center">
              <span class="badge bg-primary me-2">${r.numero_repuesto}</span>
              <div>
                <strong>${r.id.toUpperCase()}</strong> - ${r.nombre}
              </div>
            </div>
          `;
          repuestosContainer.appendChild(div);
        });
      }
      
      // Agregar un nuevo hotspot
      addHotspotForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const repuestoId = repuestoSelect.value;
        if (!repuestoId) return;
        
        const repuesto = allRepuestos.find(r => r.id === repuestoId);
        if (!repuesto) return;
        
        // Posición centrada por defecto
        const x = 50;
        const y = 50;
        
        // Verificar si ya existe un hotspot para este repuesto
        const existingIndex = hotspotsPorCategoria[currentCategory].findIndex(h => h[3] === repuestoId);
        
        if (existingIndex >= 0) {
          // Si ya existe, actualizar sus coordenadas
          hotspotsPorCategoria[currentCategory][existingIndex] = [x, y, repuesto.numero_repuesto, repuestoId, repuesto.nombre];
        } else {
          // Si no existe, agregar nuevo
          hotspotsPorCategoria[currentCategory].push([x, y, repuesto.numero_repuesto, repuestoId, repuesto.nombre]);
        }
        
        // Renderizar y actualizar
        renderHotspots();
        updateJsonOutput();
      });
      
      // Renderizar los hotspots en la imagen
      function renderHotspots() {
        // Eliminar hotspots anteriores
        document.querySelectorAll('.hotspot').forEach(el => el.remove());
        
        // Crear nuevos hotspots
        hotspotsPorCategoria[currentCategory].forEach((hotspot, index) => {
          const [x, y, numero, id, nombre] = hotspot;
          
          const el = document.createElement('div');
          el.className = 'hotspot';
          el.textContent = numero;
          el.style.left = `${x}%`;
          el.style.top = `${y}%`;
          el.setAttribute('data-index', index);
          
          // Hacer que los hotspots sean arrastrables
          makeDraggable(el);
          
          imgContainer.appendChild(el);
        });
      }
      
      // Hacer que un elemento sea arrastrable
      function makeDraggable(el) {
        let isDragging = false;
        let offsetX, offsetY;
        
        el.addEventListener('mousedown', startDrag);
        el.addEventListener('touchstart', startDrag);
        
        function startDrag(e) {
          e.preventDefault();
          
          isDragging = true;
          
          // Eventos de movimiento
          document.addEventListener('mousemove', drag);
          document.addEventListener('touchmove', drag);
          
          // Eventos de finalización
          document.addEventListener('mouseup', endDrag);
          document.addEventListener('touchend', endDrag);
        }
        
        function drag(e) {
          if (!isDragging) return;
          
          const rect = imgContainer.getBoundingClientRect();
          let clientX, clientY;
          
          if (e.type === 'touchmove') {
            clientX = e.touches[0].clientX;
            clientY = e.touches[0].clientY;
          } else {
            clientX = e.clientX;
            clientY = e.clientY;
          }
          
          // Calcular posición relativa en porcentaje
          const x = ((clientX - rect.left) / rect.width) * 100;
          const y = ((clientY - rect.top) / rect.height) * 100;
          
          // Limitar dentro de la imagen
          const boundedX = Math.max(0, Math.min(100, x));
          const boundedY = Math.max(0, Math.min(100, y));
          
          // Actualizar posición visual
          el.style.left = `${boundedX}%`;
          el.style.top = `${boundedY}%`;
          
          // Actualizar datos
          const index = parseInt(el.getAttribute('data-index'));
          hotspotsPorCategoria[currentCategory][index][0] = Math.round(boundedX);
          hotspotsPorCategoria[currentCategory][index][1] = Math.round(boundedY);
          
          // Actualizar JSON
          updateJsonOutput();
        }
        
        function endDrag() {
          isDragging = false;
          document.removeEventListener('mousemove', drag);
          document.removeEventListener('touchmove', drag);
          document.removeEventListener('mouseup', endDrag);
          document.removeEventListener('touchend', endDrag);
        }
      }
      
      // Actualizar salida JSON
      function updateJsonOutput() {
        // Convertir a formato para el archivo fetch-repuestos.js
        const outputJson = {};
        
        for (const [category, hotspots] of Object.entries(hotspotsPorCategoria)) {
          outputJson[`.filter-${category}`] = hotspots;
        }
        
        const jsonStr = JSON.stringify(outputJson, null, 2)
          .replace(/"\.filter-/g, '    ".filter-')
          .replace(/\[\n\s+/g, '[\n      ')
          .replace(/\n\s+\]/g, '\n    ]');
        
        jsonOutput.textContent = 
`const hotspotsPorCategoria = {
${jsonStr.slice(1, -1)}
};`;
      }
      
      // Copiar JSON al portapapeles
      copyJsonBtn.addEventListener('click', () => {
        navigator.clipboard.writeText(jsonOutput.textContent).then(() => {
          alert('JSON copiado al portapapeles');
        });
      });
      
      // Inicialización
      changeCategory('trompa');
      renderHotspots();
      updateJsonOutput();
    });
  </script>
</body>
</html> 